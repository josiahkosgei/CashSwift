// CashSwift.Integrations.CooperativeBank.SOAIntegrationClasses.FundsTransfers.v4_0.CoopPostRequestV4_0
using System.Globalization;
using CashSwift.API.Messaging.Integration.Transactions;
using CashSwift.Finacle.Integration.CQRS.Helpers;

namespace CashSwift.Finacle.Integration.Models.SOAIntegrationClasses.FundsTransfers.v4_0
{
    public class CoopPostRequestV4_0 : CoopFundsTransferRequestBase
    {
        private PostConfiguration PostConfiguration;

        public CoopPostRequestV4_0(PostTransactionRequest request, string branch_source, string tx_narration, PostConfiguration postConfiguration)
        {
            PostConfiguration = postConfiguration;
            RequestUUID = request.MessageID;
            MessageDateTime = request.MessageDateTime;
            string Currency = request.Transaction.CreditAccount.Currency.ToUpperInvariant();
            string TransactionDateTime = request.Transaction.DateTime.ToString(PostConfiguration.DateFormat, CultureInfo.InvariantCulture);
            string Transactionamount = request.Transaction.Amount.ToString("F");
            string text4 = null;
            if (!string.IsNullOrWhiteSpace(PostConfiguration.Realm))
            {
                text4 = "<mes:Realm>" + PostConfiguration.Realm + "</mes:Realm>";
            }
            var MessageReference = Guid.NewGuid().ToString().ToLower();
            var CorrelationID = Guid.NewGuid().ToString().ToLower();
            var TransactionDatetime = DateTime.Now.ToString("yyyy-MM-ddTHH:mm:ss.fff");

            var txnNarrative = $"CDM Cash Deposit~{request.Transaction.DebitAccount.AccountNumber}~{request.Transaction.CreditAccount.AccountNumber}~{request.Transaction.Narration}~{request.Transaction.DeviceNumber}";

            var soapRequest = $"<Envelope xmlns=\"http://schemas.xmlsoap.org/soap/envelope/\">\r\n    <Header>\r\n        <wstxns1:RequestHeader\r\n            xmlns:wstxns1=\"urn://co-opbank.co.ke/CommonServices/Data/Message/MessageHeader\">\r\n            <wstxns2:CreationTimestamp\r\n                xmlns:wstxns2=\"urn://co-opbank.co.ke/CommonServices/Data/Common\">{TransactionDatetime}</wstxns2:CreationTimestamp>\r\n            <wstxns3:CorrelationID xmlns:wstxns3=\"urn://co-opbank.co.ke/CommonServices/Data/Common\">{CorrelationID}</wstxns3:CorrelationID>\r\n            <wstxns1:MessageID>{MessageReference}</wstxns1:MessageID>\r\n            <wstxns1:Credentials>\r\n                <wstxns1:SystemCode>{request.SystemCode_Cred}</wstxns1:SystemCode>\r\n                <wstxns1:BankID>{request.BankID}</wstxns1:BankID>\r\n            </wstxns1:Credentials>\r\n        </wstxns1:RequestHeader>\r\n    </Header>\r\n    <Body>\r\n        <wstxns4:FundsTransfer\r\n            xmlns:wstxns4=\"urn://co-opbank.co.ke/Banking/CanonicalDataModel/FundsTransfer/4.0\">\r\n            <wstxns4:MessageReference>{request.DeviceReferenceNumber}</wstxns4:MessageReference>\r\n            <wstxns4:SystemCode>{request.SystemCode_FT}</wstxns4:SystemCode>\r\n            <wstxns4:TransactionDatetime>\r\n                {TransactionDatetime}</wstxns4:TransactionDatetime>\r\n            <wstxns4:ValueDate>{TransactionDatetime}</wstxns4:ValueDate>\r\n            <wstxns4:TransactionType>{postConfiguration.TransactionType}</wstxns4:TransactionType>\r\n            <wstxns4:TransactionSubType>{postConfiguration.TransactionSubType}</wstxns4:TransactionSubType>\r\n            <wstxns4:TransactionItems>\r\n                <wstxns4:TransactionItem>\r\n                    <wstxns4:TransactionReference>\r\n                        {request.DeviceReferenceNumber}</wstxns4:TransactionReference>\r\n                    <wstxns4:TransactionItemKey>\r\n                        {request.DeviceReferenceNumber}_1</wstxns4:TransactionItemKey>\r\n                    <wstxns4:AccountNumber>\r\n                        {request.Transaction.DebitAccount.AccountNumber}</wstxns4:AccountNumber>\r\n                    <wstxns4:DebitCreditFlag>D</wstxns4:DebitCreditFlag>\r\n                    <wstxns4:TransactionAmount>{request.Transaction.Amount}</wstxns4:TransactionAmount>\r\n                    <wstxns4:TransactionCurrency>{request.Transaction.CreditAccount.Currency}</wstxns4:TransactionCurrency>\r\n                    <wstxns4:Narrative>{txnNarrative}</wstxns4:Narrative>\r\n                    <wstxns4:TransactionCode>\r\n                        {postConfiguration.TransactionCode}</wstxns4:TransactionCode>\r\n                </wstxns4:TransactionItem>\r\n                <wstxns4:TransactionItem>\r\n                    <wstxns4:TransactionReference>{request.DeviceReferenceNumber}</wstxns4:TransactionReference>\r\n                    <wstxns4:TransactionItemKey>{request.DeviceReferenceNumber}_2</wstxns4:TransactionItemKey>\r\n                    <wstxns4:AccountNumber>{request.Transaction.CreditAccount.AccountNumber}</wstxns4:AccountNumber>\r\n                    <wstxns4:DebitCreditFlag>C</wstxns4:DebitCreditFlag>\r\n                    <wstxns4:TransactionAmount>{request.Transaction.Amount}</wstxns4:TransactionAmount>\r\n                    <wstxns4:TransactionCurrency>{request.Transaction.CreditAccount.Currency}</wstxns4:TransactionCurrency>\r\n                    <wstxns4:Narrative>{txnNarrative}</wstxns4:Narrative>\r\n                    <wstxns4:TransactionCode>{postConfiguration.TransactionCode}</wstxns4:TransactionCode>\r\n                </wstxns4:TransactionItem>\r\n            </wstxns4:TransactionItems>\r\n            <wstxns4:TransactionCharges>\r\n                <wstxns4:Charge>\r\n                    <wstxns4:EventType />\r\n                    <wstxns4:EventId />\r\n                </wstxns4:Charge>\r\n            </wstxns4:TransactionCharges>\r\n        </wstxns4:FundsTransfer>\r\n    </Body>\r\n</Envelope>";

            RawXML = soapRequest;//"<soapenv:Envelope xmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\" xmlns:mes=\"urn://co-opbank.co.ke/CommonServices/Data/Message/MessageHeader\" xmlns:com=\"urn://co-opbank.co.ke/CommonServices/Data/Common\" xmlns:ns=\"urn://co-opbank.co.ke/Banking/CanonicalDataModel/FundsTransfer/2.5\">\r\n   <soapenv:Header>\r\n      <mes:RequestHeader>\r\n         <!--Optional:-->\r\n         <com:CreationTimestamp>" + MessageDateTime.ToString(PostConfiguration.DateFormat, CultureInfo.InvariantCulture) + "</com:CreationTimestamp>\r\n         <!--Optional:-->\r\n         <com:CorrelationID>" + RequestUUID + "</com:CorrelationID>\r\n         <mes:MessageID>" + Guid.NewGuid().ToString().ToUpperInvariant() + "</mes:MessageID>\r\n         <!--Optional:-->\r\n         <mes:Credentials>\r\n            <!--Optional:-->\r\n            <mes:SystemCode>" + PostConfiguration.SystemCode + "</mes:SystemCode>\r\n            <!--Optional:-->\r\n            <mes:Username>" + PostConfiguration.Username + "</mes:Username>\r\n            <!--Optional:-->\r\n            <mes:Password>" + PostConfiguration.Password + "</mes:Password>\r\n            <!--Optional:-->\r\n            " + text4 + "\r\n         </mes:Credentials>\r\n      </mes:RequestHeader>\r\n   </soapenv:Header>\r\n   <soapenv:Body>\r\n      <ns:FundsTransferRequest>\r\n         <ns:FundsTransferReqData>\r\n            <!--Optional:-->\r\n            <ns:OperationParameters>\r\n               <ns:MessageType>NORMAL</ns:MessageType>\r\n               <ns:UserID>" + PostConfiguration.UserID + "</ns:UserID>\r\n               <ns:ValueDate>" + TransactionDateTime + "</ns:ValueDate>\r\n               <ns:ExchangeRateDetails>\r\n                  <ns:FromCurrency>" + Currency + "</ns:FromCurrency>\r\n                  <ns:ExchangeRate>1.00</ns:ExchangeRate>\r\n                  <ns:ExchangeRateFlag>M</ns:ExchangeRateFlag>\r\n                  <ns:ToCurrency>" + Currency + "</ns:ToCurrency>\r\n               </ns:ExchangeRateDetails>\r\n            </ns:OperationParameters>\r\n            <ns:TransactionItems>\r\n               <!--1 or more repetitions:-->\r\n               <ns:TransactionItem>\r\n                  <ns:TransactionItemKey>" + request.DeviceReferenceNumber + "1</ns:TransactionItemKey>\r\n                  <ns:AccountNumber>" + request.Transaction.DebitAccount.AccountNumber + "</ns:AccountNumber>\r\n                  <ns:DebitCreditFlag>D</ns:DebitCreditFlag>\r\n                  <ns:TransactionAmount>" + Transactionamount + "</ns:TransactionAmount>\r\n                  <ns:TransactionCurrency>" + Currency + "</ns:TransactionCurrency>\r\n                  <ns:TransactionReference>" + request.DeviceReferenceNumber + "</ns:TransactionReference>\r\n                  <ns:Narrative>" + tx_narration + "</ns:Narrative>\r\n                  <ns:BaseEquivalent>1</ns:BaseEquivalent>\r\n                  <ns:SourceBranch>" + branch_source + "</ns:SourceBranch>\r\n                  <ns:TransactionCode>" + PostConfiguration.TransactionCode + "</ns:TransactionCode>\r\n               </ns:TransactionItem>\r\n               <ns:TransactionItem>\r\n                  <ns:TransactionItemKey>" + request.DeviceReferenceNumber + "2</ns:TransactionItemKey>\r\n                  <ns:AccountNumber>" + request.Transaction.CreditAccount.AccountNumber + "</ns:AccountNumber>\r\n                  <ns:DebitCreditFlag>C</ns:DebitCreditFlag>\r\n                  <ns:TransactionAmount>" + Transactionamount + "</ns:TransactionAmount>\r\n                  <ns:TransactionCurrency>" + Currency + "</ns:TransactionCurrency>\r\n                  <ns:TransactionReference>" + request.DeviceReferenceNumber + "</ns:TransactionReference>\r\n                  <ns:Narrative>" + tx_narration + "</ns:Narrative>\r\n                  <ns:BaseEquivalent>1</ns:BaseEquivalent>\r\n                  <ns:SourceBranch>" + branch_source + "</ns:SourceBranch>\r\n                  <ns:TransactionCode>" + PostConfiguration.TransactionCode + "</ns:TransactionCode>\r\n               </ns:TransactionItem>\r\n            </ns:TransactionItems>\r\n         </ns:FundsTransferReqData>\r\n      </ns:FundsTransferRequest>\r\n   </soapenv:Body>\r\n</soapenv:Envelope>";
        }
    }
}