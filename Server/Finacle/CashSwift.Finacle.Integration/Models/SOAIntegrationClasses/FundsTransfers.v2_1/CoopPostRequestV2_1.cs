// CashSwift.Integrations.CooperativeBank.SOAIntegrationClasses.FundsTransfers.v2_1.CoopPostRequestV2_1
using System.Globalization;
using CashSwift.API.Messaging.Integration.Transactions;
using CashSwift.Finacle.Integration.CQRS.Helpers;
using CashSwift.Finacle.Integration.DataAccess.Dapper;

namespace CashSwift.Finacle.Integration.Models.SOAIntegrationClasses.FundsTransfers.v2_1
{
    public class CoopPostRequestV2_1 : CoopFundsTransferRequestBase
    {
        private PostConfiguration PostConfiguration;

        public CoopPostRequestV2_1(PostTransactionRequest request, string tx_narration, IConfiguration configuration)
        {
            IntegrationDataAccess DBContext = new IntegrationDataAccess(configuration);
            PostConfiguration = configuration.GetValue<PostConfiguration>("PostConfiguration");
            RequestUUID = request.MessageID;
            MessageDateTime = request.MessageDateTime;
            string text = Task.Run(() => DBContext.GetCurrencyAsync(request.Transaction.CreditAccount.Currency)).Result?.ISO_3_Numeric_Code ?? throw new ArgumentException("Currency " + request.Transaction.CreditAccount.Currency + " does not exist in database");
            string text2 = request.Transaction.DateTime.ToString(PostConfiguration.DateFormat, CultureInfo.InvariantCulture);
            string text3 = request.Transaction.Amount.ToString("F");
            RawXML = "<S:Envelope xmlns:env=\"http://schemas.xmlsoap.org/soap/envelope/\" xmlns:S=\"http://schemas.xmlsoap.org/soap/envelope/\" xmlns:soap=\"urn://co-opbank.co.ke/SharedResources/Schemas/SOAMessages/SoapHeader\">\r\n    <env:Header>\r\n        <soap:HeaderRequest>\r\n            <soap:MessageID>" + RequestUUID + "</soap:MessageID>\r\n            <soap:Credentials>\r\n                <soap:SystemCode>010</soap:SystemCode>\r\n            </soap:Credentials>\r\n        </soap:HeaderRequest>\r\n    </env:Header>\r\n    <S:Body>\r\n        <DataInput xmlns=\"urn://co-opbank.co.ke/Banking/Account/Service/AccountFundsTransfer/Post/2.1/DataIO\" xmlns:ns0=\"urn://co-opbank.co.ke/SharedResources/Schemas/SOAMessages/SoapHeader\" xmlns:ns1=\"urn://co-opbank.co.ke/Banking/CanonicalDataModel/FundsTransfer/1.1\" xmlns:ns2=\"urn://co-opbank.co.ke/Banking/Account/DataModel/AccountFundsTransfer/Post/2.1/AccountFundsTransfer.post\">\r\n            <ns2:postInput>\r\n                <ns1:FundsTransfer>\r\n                    <ns1:orig>\r\n                        <ns1:channelId>ATM</ns1:channelId>\r\n                    </ns1:orig>\r\n                    <ns1:messageType>ATMFundTransfer</ns1:messageType>\r\n                    <ns1:atmMessageHeader>\r\n                        <ns1:atmMsgType>\r\n                            <ns1:messageFunction></ns1:messageFunction>\r\n                        </ns1:atmMsgType>\r\n                    </ns1:atmMessageHeader>\r\n                    <ns1:txnInputData>\r\n                        <ns1:tellerTxnReference>" + request.DeviceReferenceNumber + "</ns1:tellerTxnReference>\r\n                    </ns1:txnInputData>\r\n                    <ns1:narrative>\r\n                        <ns1:reference>" + request.Transaction.Narration + "</ns1:reference>\r\n                    </ns1:narrative>\r\n                    <ns1:debitPosting>\r\n                        <ns1:account>\r\n                            <ns1:inputAccount>\r\n                                <ns1:inputAccountId>" + request.Transaction.DebitAccount.AccountNumber + "</ns1:inputAccountId>\r\n                            </ns1:inputAccount>\r\n                        </ns1:account>\r\n                        <ns1:currency>\r\n                            <ns1:isoCurrencyCode>" + text + "</ns1:isoCurrencyCode>\r\n                            <ns1:amount>" + text3 + "</ns1:amount>\r\n                        </ns1:currency>\r\n                        <ns1:valueDate>" + text2 + "</ns1:valueDate>\r\n                    </ns1:debitPosting>\r\n                    <ns1:creditPosting>\r\n                        <ns1:account>\r\n                            <ns1:inputAccount>\r\n                                <ns1:inputAccountId>" + request.Transaction.CreditAccount.AccountNumber + "</ns1:inputAccountId>\r\n                            </ns1:inputAccount>\r\n                        </ns1:account>\r\n                        <ns1:currency>\r\n                            <ns1:isoCurrencyCode>" + text + "</ns1:isoCurrencyCode>\r\n                            <ns1:amount>" + text3 + "</ns1:amount>\r\n                        </ns1:currency>\r\n                        <ns1:valueDate>" + text2 + "</ns1:valueDate>\r\n                    </ns1:creditPosting>\r\n<ns1:atmDetails>\r\n                        <ns1:processingCode>\r\n                            <ns1:txnType>40</ns1:txnType>\r\n                            <ns1:acctType1>00</ns1:acctType1>\r\n                            <ns1:acctType2>00</ns1:acctType2>\r\n                        </ns1:processingCode>\r\n                        <ns1:amountTrans>\r\n                            <ns1:isoCurrencyCode>" + text + "</ns1:isoCurrencyCode>\r\n                            <ns1:amount>" + text3 + "</ns1:amount>\r\n                        </ns1:amountTrans>\r\n                        <ns1:reconRate>45</ns1:reconRate>\r\n                        <ns1:txnDateTime>" + text2 + "</ns1:txnDateTime>\r\n                        <ns1:track2Data>MBANKDUMMYCARDNO</ns1:track2Data>\r\n                        <ns1:pINData>" + tx_narration + "</ns1:pINData>\r\n                        <ns1:originalDataEle>\r\n                            <ns1:orgAuditNo>" + request.DeviceReferenceNumber + "</ns1:orgAuditNo>\r\n                            <ns1:orgDateTime>" + text2 + "</ns1:orgDateTime>\r\n                        </ns1:originalDataEle>\r\n                       <ns1:accIdentification1>" + request.Transaction.DebitAccount.AccountNumber + "</ns1:accIdentification1>\r\n                        <ns1:accIdentification2>" + request.Transaction.CreditAccount.AccountNumber + "</ns1:accIdentification2>\r\n                    </ns1:atmDetails>\r\n                </ns1:FundsTransfer>\r\n            </ns2:postInput>\r\n        </DataInput>\r\n    </S:Body>\r\n    </S:Envelope>";
        }
    }

}